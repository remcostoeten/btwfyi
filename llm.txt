# Vigilo - LLM Integration Guide

> A lightweight task awareness overlay for development environments.
> Latin "btwfyi" â€” to watch, stay alert, keep aware.

## Overview

Vigilo is a React/Vue overlay component that displays development tasks and can draw visual connector lines from tasks to DOM elements. It supports localStorage or database persistence.

---

## 1. Installation

### pnpm
```bash
pnpm add btwfyi
```

### bun
```bash
bun add btwfyi
```

### npm
```bash
npm install btwfyi
```

---

## 2. Basic Setup - Render Vigilo in React

```tsx
import { Vigilo } from 'btwfyi/react'
import type { CategoryConfig } from 'btwfyi'

const categories: CategoryConfig[] = [
  {
    id: 'development',
    displayName: 'Dev Tasks',
    items: [
      { text: 'Fix auth bug', action: 'fix', priority: 'high' },
      { text: 'Add profile page', action: 'feat', priority: 'medium' },
      { text: 'Optimize queries', action: 'perf', priority: 'low' },
    ],
  },
]

export default function App() {
  return (
    <Vigilo
      category="development"
      categories={categories}
      enabled={process.env.NODE_ENV === 'development'}
    />
  )
}
```

---

## 3. Define Tasks/Todos Programmatically

### CategoryConfig Structure
```typescript
type TodoItem = {
  text: string              // Main task text (required)
  action?: string           // Short label: 'fix', 'feat', 'perf', etc.
  info?: string             // Short info text
  description?: string      // Longer description
  notes?: string            // Additional notes
  priority?: 'low' | 'medium' | 'high'
  tags?: string[]           // Tags for filtering
  createdAt?: string        // ISO 8601 timestamp
  updatedAt?: string        // ISO 8601 timestamp
}

type CategoryConfig = {
  id: string                // Unique category identifier
  displayName?: string      // Human-readable name (falls back to id)
  items: TodoItem[]         // Array of tasks
}
```

### Example with Multiple Categories
```tsx
const categories: CategoryConfig[] = [
  {
    id: 'frontend',
    displayName: 'Frontend Tasks',
    items: [
      { text: 'Implement dark mode', action: 'feat', priority: 'high', tags: ['ui', 'theme'] },
      { text: 'Fix mobile menu', action: 'fix', priority: 'medium' },
    ],
  },
  {
    id: 'backend',
    displayName: 'Backend Tasks',
    items: [
      { text: 'Add rate limiting', action: 'feat', priority: 'high' },
      { text: 'Optimize database queries', action: 'perf', priority: 'low' },
    ],
  },
]

// Render multiple Vigilo instances
<Vigilo category="frontend" categories={categories} />
<Vigilo category="backend" categories={categories} instanceId="backend-panel" />
```

---

## 4. Add Connectors Programmatically

Use the `useVigiloInstance` hook to add/remove connections from code.

### Hook API
```typescript
import { useVigiloInstance } from 'btwfyi/react'

const { addConnection, removeConnection, setConnections, getConnections } = useVigiloInstance({
  instanceId: 'development', // Must match your Vigilo category/instanceId
})
```

### Add Connection Methods

```tsx
// 1. Connect to CSS selector
addConnection(0, '#my-button')
addConnection(1, '.sidebar-nav', 'Navigation')

// 2. Connect to DOM element
const element = document.querySelector('#feature-section')
addConnection(2, element, 'Feature Section')

// 3. Connect to fixed position (freeroam)
addConnection(3, { x: 500, y: 300 })
```

### Set All Connections at Once (for AI automation)
```tsx
const connections = [
  { todoIndex: 0, targetSelector: '#header', targetLabel: 'Header' },
  { todoIndex: 1, targetSelector: '.sidebar', targetLabel: 'Sidebar' },
  { todoIndex: 2, targetSelector: '#submit-btn', targetLabel: 'Submit' },
  { todoIndex: 3, targetPosition: { x: 800, y: 400 } }, // Freeroam
]

setConnections(connections)
```

### Connection Type
```typescript
type Connection = {
  todoIndex: number          // 0-based task index
  targetSelector?: string    // CSS selector (mutually exclusive with targetPosition)
  targetLabel?: string       // Display label
  targetPosition?: { x: number; y: number }  // Fixed coordinates
}
```

### Auto-Connect Example
```tsx
import { useVigiloInstance } from 'btwfyi/react'
import { useEffect } from 'react'

function AutoConnector() {
  const { setConnections } = useVigiloInstance({ instanceId: 'development' })

  useEffect(() => {
    const mappings = [
      { todoIndex: 0, selector: '#login-form' },
      { todoIndex: 1, selector: '#dashboard' },
      { todoIndex: 2, selector: '.user-profile' },
    ]

    setConnections(
      mappings.map(({ todoIndex, selector }) => ({
        todoIndex,
        targetSelector: selector,
        targetLabel: document.querySelector(selector)?.textContent?.slice(0, 20) || selector,
      }))
    )
  }, [])

  return null
}
```

---

## 5. Style Connectors

### Via Theme Overrides
```tsx
<Vigilo
  category="development"
  categories={categories}
  themeOverrides={{
    colors: {
      primary: 'rgb(255, 100, 100)',      // Line color for DOM connections
      freeroam: 'rgb(100, 255, 100)',     // Line color for freeroam connections
    },
  }}
/>
```

### Via Styles Overrides (SVG attributes)
```tsx
<Vigilo
  category="development"
  categories={categories}
  stylesOverrides={{
    connectorDot: {
      fill: '#ff0000',   // Endpoint dot color
      r: 6,              // Endpoint dot radius
    },
    freeroamDot: {
      fill: '#00ff00',
      stroke: '#00ff00',
      strokeWidth: 2,
      r: 5,
      opacity: 0.8,
    },
  }}
/>
```

### Connector Line Properties (runtime)
Lines are drawn as SVG paths with these default properties:
- `strokeWidth`: 2
- `strokeDasharray`: "6 4" (dashed line)
- `opacity`: controlled by `lineOpacity` (default 0.5)
- Color: controlled by `lineColor` or theme

### Change Line Color/Opacity at Runtime
The user can adjust these in the Vigilo settings panel, or programmatically:
```tsx
const { store } = useVigiloInstance({ instanceId: 'development' })
store?.setLineColor('#ff6b6b')
store?.setLineOpacity(0.8)
```

---

## 6. Style Vigilo Panel

### Theme Structure
```typescript
interface Theme {
  colors: {
    primary: string       // Accent color (lines, highlights)
    primaryDim: string    // Dimmed primary (backgrounds)
    freeroam: string      // Freeroam indicator color
    textMain: string      // Main text (Tailwind class or CSS)
    textDim: string       // Secondary text
    bgPanel: string       // Panel background
    borderPanel: string   // Panel border
    bgOverlay: string     // Overlay background
  }
  layout: {
    panel: string         // Panel CSS classes
    item: string          // Item CSS classes
    header: string        // Header CSS classes
    badge: string         // Badge CSS classes
  }
  z: {
    lines: number         // z-index for connector lines (default: 9990)
    overlay: number       // z-index for overlay (default: 9995)
    panel: number         // z-index for panel (default: 9999)
  }
}
```

### Full Theme Override Example
```tsx
<Vigilo
  category="development"
  categories={categories}
  colorMode="dark"
  themeOverrides={{
    colors: {
      primary: '#10b981',
      primaryDim: 'rgba(16, 185, 129, 0.1)',
      freeroam: '#f59e0b',
      textMain: 'text-white',
      textDim: 'text-gray-400',
      bgPanel: 'bg-gray-900',
      borderPanel: 'border-gray-700',
    },
    layout: {
      panel: 'fixed flex flex-col gap-2 border px-4 pb-4 pt-0 w-80 shadow-xl rounded-lg',
      item: 'relative flex items-center gap-3 p-2 transition-colors rounded',
    },
    z: {
      panel: 10000,
      lines: 9990,
      overlay: 9995,
    },
    modes: {
      light: {
        colors: {
          textMain: 'text-gray-900',
          bgPanel: 'bg-white',
          borderPanel: 'border-gray-200',
        },
      },
      dark: {
        colors: {
          textMain: 'text-gray-100',
          bgPanel: 'bg-zinc-950',
          borderPanel: 'border-zinc-800',
        },
      },
    },
  }}
/>
```

---

## 7. Database Persistence with Drizzle

### Install Database Package
```bash
pnpm add @btwfyi/database drizzle-orm postgres
```

### Generate Drizzle Schema
```bash
npx btwfyi-db --drizzle --out lib/db/schema.ts
```

### Drizzle Schema (generated)
```typescript
// lib/db/schema.ts
import { pgTable, varchar, integer, boolean, real, timestamp } from 'drizzle-orm/pg-core'

export const btwfyiInstance = pgTable('btwfyi_instance', {
  id: varchar('id', { length: 255 }).primaryKey(),
  instanceKey: varchar('instance_key', { length: 255 }).unique().notNull(),
  userId: varchar('user_id', { length: 255 }),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
})

export const btwfyiPosition = pgTable('btwfyi_position', {
  id: varchar('id', { length: 255 }).primaryKey(),
  instanceId: varchar('instance_id', { length: 255 }).notNull(),
  x: integer('x').notNull(),
  y: integer('y').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
})

export const btwfyiConnection = pgTable('btwfyi_connection', {
  id: varchar('id', { length: 255 }).primaryKey(),
  instanceId: varchar('instance_id', { length: 255 }).notNull(),
  todoIndex: integer('todo_index').notNull(),
  targetSelector: varchar('target_selector', { length: 255 }),
  targetLabel: varchar('target_label', { length: 255 }),
  targetPositionX: integer('target_position_x'),
  targetPositionY: integer('target_position_y'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
})

export const btwfyiSettings = pgTable('btwfyi_settings', {
  id: varchar('id', { length: 255 }).primaryKey(),
  instanceId: varchar('instance_id', { length: 255 }).notNull(),
  displayMode: varchar('display_mode', { length: 50 }).default('full').notNull(),
  isHidden: boolean('is_hidden').default(false).notNull(),
  showLines: boolean('show_lines').default(true).notNull(),
  showBadges: boolean('show_badges').default(true).notNull(),
  lineColor: varchar('line_color', { length: 20 }).default('#3b82f6').notNull(),
  lineOpacity: real('line_opacity').default(0.5).notNull(),
  componentOpacity: real('component_opacity').default(1.0).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
})

export const btwfyiStatus = pgTable('btwfyi_status', {
  id: varchar('id', { length: 255 }).primaryKey(),
  instanceId: varchar('instance_id', { length: 255 }).notNull(),
  todoIndex: integer('todo_index').notNull(),
  status: varchar('status', { length: 20 }).default('todo').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
})
```

### Create API Route (Next.js App Router)
```typescript
// app/api/btwfyi/state/[instanceKey]/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { createVigiloApiHandlers } from '@btwfyi/database/server/handlers'
import { createVigiloDrizzleQueries } from '@btwfyi/database/server/drizzle'
import { drizzle } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'
import * as schema from '@/lib/db/schema'

const client = postgres(process.env.DATABASE_URL!)
const db = drizzle(client, { schema })
const queries = createVigiloDrizzleQueries(db)
const handlers = createVigiloApiHandlers(queries)

export async function GET(
  request: NextRequest,
  { params }: { params: { instanceKey: string } }
) {
  return handlers.handleLoadState(request, { params })
}

export async function POST(
  request: NextRequest,
  { params }: { params: { instanceKey: string } }
) {
  const body = await request.json()
  const { type } = body

  switch (type) {
    case 'position': return handlers.handleSavePosition(request, { params })
    case 'connections': return handlers.handleSaveConnections(request, { params })
    case 'displayMode': return handlers.handleSaveDisplayMode(request, { params })
    case 'hidden': return handlers.handleSaveHidden(request, { params })
    case 'showLines': return handlers.handleSaveShowLines(request, { params })
    case 'showBadges': return handlers.handleSaveShowBadges(request, { params })
    case 'lineColor': return handlers.handleSaveLineColor(request, { params })
    case 'lineOpacity': return handlers.handleSaveLineOpacity(request, { params })
    case 'componentOpacity': return handlers.handleSaveComponentOpacity(request, { params })
    case 'statuses': return handlers.handleSaveStatuses(request, { params })
    default:
      return NextResponse.json({ error: 'Invalid update type' }, { status: 400 })
  }
}
```

### Use VigiloProvider (Recommended)
```tsx
'use client'

import { VigiloProvider } from '@btwfyi/database'
import { Vigilo } from 'btwfyi/react'

export default function App() {
  return (
    <VigiloProvider
      baseUrl="/api/btwfyi"
      defaultInstanceId="user-tasks"
      getAuthToken={() => localStorage.getItem('authToken') || undefined}
    >
      <Vigilo category="development" categories={categories} />
    </VigiloProvider>
  )
}
```

### Manual Storage Integration
```tsx
'use client'

import { createApiVigiloStorage } from '@btwfyi/database'
import { Vigilo } from 'btwfyi/react'
import { useEffect, useState } from 'react'

export default function App() {
  const [storage, setStorage] = useState(null)

  useEffect(() => {
    const apiStorage = createApiVigiloStorage({
      baseUrl: '/api/btwfyi',
      instanceId: 'user-tasks',
      token: localStorage.getItem('authToken') || undefined,
      timeout: 10000,
    })
    setStorage(apiStorage)
  }, [])

  if (!storage) return <div>Loading...</div>

  return <Vigilo storage={storage} category="development" categories={categories} />
}
```

---

## 8. Props Reference

### Vigilo Component Props
```typescript
interface VigiloProps {
  category: string                    // Category ID to display (required)
  categories: CategoryConfig[]        // Array of all categories (required)
  instanceId?: string                 // Unique instance ID (defaults to category)
  enabled?: boolean                   // Enable/disable component (default: true)
  storage?: VigiloStorage             // Custom storage adapter
  themeOverrides?: ThemeOverrides     // Theme customization
  stylesOverrides?: Partial<Styles>   // Style customization
  colorMode?: 'light' | 'dark'        // Color mode for theme
}
```

### useVigiloInstance Hook
```typescript
interface UseVigiloInstanceOptions {
  instanceId: string        // Must match Vigilo category/instanceId
  lineColor?: string        // Optional line color override
}

interface UseVigiloInstanceReturn {
  store: VigiloStore | null
  getState: () => VigiloState | null
  addConnection: (todoIndex: number, target: string | Element | Pos, label?: string) => void
  removeConnection: (todoIndex: number) => void
  setConnections: (connections: Connection[]) => void
  getConnections: () => Connection[]
}
```

---

## 9. Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `s` | Open settings |
| `?` | Show keyboard help |
| `/` | Focus search |
| `l` | Toggle lines |
| `b` | Toggle badges |
| `Escape` | Close modals |
| `Ctrl+E` | Export config |
| `Ctrl+I` | Import config |
| `1` | Full mode (in settings) |
| `2` | Compact mode (in settings) |
| `3` | Minimal mode (in settings) |
| `d` | Hide panel (in settings) |

---

## 10. Display Modes

- **full**: Shows all task details, descriptions, and actions
- **compact**: Shows minimal task info, single item visible
- **minimal**: Dot indicator that expands on hover

---

## 11. Connection Behavior

### DOM-based connections (`targetSelector`)
- Stores CSS selector (e.g., `#submit-button`)
- Line endpoint automatically updates when:
  - Page scrolls
  - Window resizes
  - Widget is dragged
- Disappears if element is removed from DOM

### Freeroam connections (`targetPosition`)
- Stores absolute `{ x, y }` coordinates
- Position is static (doesn't update on scroll)
- Can be repositioned by dragging the endpoint dot

### User Interactions
- **Click task "link" icon**: Enter selection mode, click DOM element to connect
- **Hold Shift + click**: Create freeroam connection at cursor position
- **Drag endpoint dot**: Reposition any connection (converts DOM to freeroam)
- **Double-click endpoint**: Remove connection
